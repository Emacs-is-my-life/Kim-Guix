# Don't ask me
set debuginfod enabled off

# Aesthetics
set style enabled on
set style sources on
set print pretty on
set print array-indexes on

# QoL
set pagination off
set history save on
set history size 10000
set history filename ~/.gdb_history

# Intel syntax
set disassembly-flavor intel

# sc (scratch) command to print output to the scratchpad
python
import gdb
import os

from pygments import highlight
from pygments.lexers import (
    CLexer,
    CppLexer,
    RustLexer,
    GasLexer,
    NasmLexer,  # Intel Syntax
)
from pygments.formatters import Terminal256Formatter

class ScratchCommand(gdb.Command):
    """
    Run a GDB command and redirect its output to the scratch file.
    Usage: sc <command>
    Example: sc print *my_huge_struct_array@1000
    """
    def __init__(self):
        # Define the command 'scratch'
        super(ScratchCommand, self).__init__("sc", gdb.COMMAND_USER)
        self.logfile = "/tmp/gdb-scratch"
        self.counter = 0

        with open(self.logfile, 'w') as f:
            f.write("--- GDB Scratchpad Initialized ---\n\n")

    def get_lexer(self):
        try:
            lang = gdb.parameter("language")

            if "asm" in lang:
                try:
                    flavor = gdb.parameter("disassembly-flavor")
                    if "intel" in flavor:
                        return NasmLexer()
                    else:
                        return GasLexer()
                except:
                    return NasmLexer()

            elif "rust" in lang:
                return RustLexer()
            elif "c++" in lang or "gnu-c++" in lang:
                return CppLexer()
            elif "c" in lang:
                return CLexer()
            else:
                return CppLexer()
        except Exception:
            return CppLexer()

    def invoke(self, arg, from_tty):
        # ANSI Color Constants
        BOLD_BLUE = "\033[1;34m"
        BOLD_GREEN = "\033[1;32m"
        BOLD_RED = "\033[1;31m"
        RESET = "\033[0m"

        # Pretty print
        gdb.execute("set print pretty on")
        gdb.execute("set print array on")

        # Open file
        with open(self.logfile, 'a') as f:
            f.write(f"{BOLD_BLUE}IN [{RESET}{self.counter}{BOLD_BLUE}]{RESET}: {arg}\n")

            # Run the actual command (logging captures the output)
            try:
                gdb_output = gdb.execute(arg, to_string=True)
                lexer = self.get_lexer()
                colored_output = highlight(gdb_output, lexer, Terminal256Formatter(style='base16-hopscotch'))
                f.write(f"{BOLD_GREEN}OUT [{RESET}{self.counter}{BOLD_GREEN}]{RESET}:\n" + colored_output + "\n\n")
            except Exception as e:
                f.write(f"{BOLD_RED}ERR [{RESET}{self.counter}{BOLD_RED}]{RESET}:\n{e}\n\n")
            finally:
                self.counter += 1

ScratchCommand()
end
